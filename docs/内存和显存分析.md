# 2DGS 内存和显存使用分析

## 核心发现：数据主要存储在内存（CPU），不是显存！

---

## 1. 数据加载策略

### 关键代码：`scene/cameras.py` 第 18-20 行

```python
self.original_image = image.clamp(0.0, 1.0)  # move to device at dataloader to reduce VRAM requirement
```

**重要注释**：原始图像存储在 CPU（data_device），减少显存需求

### 数据流向

```
视频文件 (video.mp4)
    ↓ ffmpeg
图片文件 (images/*.jpg) → 磁盘
    ↓ COLMAP
点云 + 相机位姿 (sparse/) → 磁盘
    ↓ 2DGS Scene 初始化
内存 (RAM):
  - ✅ 所有图片数据 (303 张 × 1920×3424 RGB)
  - ✅ 点云 (57,059 个 3D 点)
  - ✅ 相机参数 (303 个相机)
  - ✅ 高斯模型参数 (点云)
显存 (VRAM):
  - ✅ 当前渲染的图片 (1-4 张，可配置)
  - ✅ 高斯模型参数 (优化中)
  - ✅ 渲染中间结果
  - ✅ 梯度和优化器状态
```

---

## 2. 内存使用估算

### 图片数据
```
303 张图片 × 1920×3424×3 通道 (uint8) = 303 × 19.7MB = 5.98GB
```

**但实际加载时会根据分辨率缩放：**
```python
# arguments/__init__.py 第 22 行
self.data_device = "cuda"  # 默认配置，但实际代码在 CPU 上存储

# camera_utils.py 第 16-30 行
if args.resolution in [1, 2, 4, 8]:
    resolution = round(orig_w/(resolution_scale * args.resolution)), round(orig_h/(resolution_scale * args.resolution))
else:
    if args.resolution == -1:  # 默认：根据图片大小自动缩放
        if orig_w > 1600:
            print("[ INFO ] Encountered quite large input images (>1.6K pixels width), rescaling to 1.6K.")
            global_down = orig_w / 1600
        else:
            global_down = 1
    scale = float(global_down) * float(resolution_scale)
    resolution = (int(orig_w / scale), int(orig_h / scale))
```

**你的图片：1920×3424**
- 原始分辨率：超过 1600 宽度，自动缩放到 1.6K
- 缩放后分辨率：1600×2852
- 内存占用：`303 × 1600×2852×3 bytes = 4.1GB`

### 点云数据
```
57,059 个 3D 点 × 3 坐标 (float32) = 57,059 × 3 × 4 bytes = 0.68GB
57,059 个法向 × 3 (float32) = 0.68GB
57,059 个颜色 × 3 (float32) = 0.68GB
点云总计：~2.0GB
```

### 总内存占用估算
```
图片：4.1GB
点云：2.0GB
相机参数：0.1GB
Python 开销：2-3GB
----------------------
总计：~8-9GB
```

**你的系统内存：32GB**
```
Total: 32.7GB
Available: 12.9GB
Cached: 4.3GB
Active: 2.6GB
```

**内存占用情况：合理**

---

## 3. 显存使用估算

### 显存占用低的可能原因

#### 原因 1：数据在 CPU 上存储 ✅（主要）
```python
# cameras.py 第 18 行
self.original_image = image.clamp(0.0, 1.0)  # move to device at dataloader
```

原始图片存储在 CPU 内存中，只在渲染时传输到显存。

#### 原因 2：只存储当前渲染需要的图片
```python
# train.py 第 45-48 行
if not viewpoint_stack:
    viewpoint_stack = scene.getTrainCameras().copy()
    viewpoint_cam = viewpoint_stack.pop(randint(0, len(viewpoint_stack)-1))
```

每次迭代只随机选择 **1 张图片**进行渲染。

#### 原因 3：批处理大小为 1
2DGS 默认批处理大小为 1（每次只处理一张图片），大大降低显存需求。

#### 原因 4：高斯模型参数
高斯模型参数占用的显存取决于：
- 点数（迭代中变化）：57,059 → ~100,000+ (密集后)
- SH 系数（3 阶）：每点 48 个参数
- 每个高斯的参数：3 (位置) + 4 (旋转) + 1 (不透明度) + 3 (缩放) = 11 个 float
- 显存占用：`100,000 × 11 × 4 bytes = 4.4GB`

但优化器状态、梯度、中间渲染结果也会占用显存。

---

## 4. 实际显存使用情况

### 检查方法

```bash
# Windows (PowerShell/WSL2)
nvidia-smi

# WSL2 内部
watch -n 1 nvidia-smi  # 实时监控
```

### 预期显存占用

| 阶段 | 点数 | 显存占用 | 说明 |
|------|------|---------|------|
| 初始化 | 57,059 | ~2-3GB | 点云 + 模型参数 |
| 训练开始 | 57,059 | ~6-8GB | + 梯度 + 优化器 + 渲染 |
| 密集化后 | ~100,000+ | ~8-10GB | 点数增加，显存增加 |
| 最终模型 | ~200,000+ | ~10-12GB | 最终高斯模型 |

**你的 RTX 5070：12GB 显存**

- ✅ 足够运行 2DGS
- ✅ 显存占用 50-80% 是正常的（不接近 100%）
- ✅ 如果显存占用低（<30%），可能是批处理大小或分辨率设置较低

---

## 5. 优化建议

### 如何减少显存占用

#### 1. 降低分辨率
```bash
python train.py -s data/my_video/sparse_undistorted -m output/my_video --resolution 2
```
- `--resolution 1`: 原始分辨率（自动缩放到 1.6K）
- `--resolution 2`: 降低 2 倍分辨率
- `--resolution 4`: 降低 4 倍分辨率

#### 2. 减少高斯模型复杂度
```bash
python train.py -s data/my_video/sparse_undistorted -m output/my_video \
    --sh_degree 1  # 降低 SH 系数从 3 到 1（质量下降，速度提升）
```

#### 3. 降低初始点数
修改 `arguments/__init__.py`：
```python
class OptimizationParams(ParamGroup):
    def __init__(self, parser):
        self.percent_dense = 0.005  # 默认 0.01，降低到 0.005 可以减少初始点数
```

#### 4. 使用更少的迭代次数
```bash
python train.py -s data/my_video/sparse_undistorted -m output/my_video \
    --iterations 15000  # 默认 30000，减少一半
```

#### 5. 关闭正则化
```bash
python train.py -s data/my_video/sparse_undistorted -m output/my_video \
    --lambda_normal 0 \
    --lambda_dist 0
```

---

## 6. 监控资源使用

### 实时监控脚本
```bash
# 创建监控脚本
cat > monitor.sh << 'EOF'
#!/bin/bash
while true; do
    clear
    echo "=== 内存使用 ==="
    free -h | head -5
    echo ""
    echo "=== 显存使用 ==="
    nvidia-smi --query-gpu=memory.used,memory.total,memory.free,utilization.gpu --format=csv
    echo ""
    echo "=== 进程 ==="
    ps aux | grep "python train.py"
    echo ""
    date
    sleep 2
done
EOF

chmod +x monitor.sh
./monitor.sh
```

### TensorBoard 监控
```bash
# 训练时会自动生成 TensorBoard 日志
tensorboard --logdir output/my_video
```

---

## 总结

### 为什么显存占用不高？

1. **设计优化**：原始图片存储在 CPU 内存（cameras.py 注释说明）
2. **批处理大小为 1**：每次只渲染一张图片
3. **按需加载**：只传输当前渲染需要的数据到显存
4. **分辨率自动缩放**：大图片自动缩放到 1.6K

### 内存占用情况

- **图片数据**：~4GB（303 张缩放后）
- **点云数据**：~2GB
- **总计**：~8-9GB（32GB 系统内存，占用合理）

### 显存占用情况

- **初始**：~6-8GB
- **密集化后**：~8-10GB
- **最终模型**：~10-12GB
- **你的 12GB 显存**：足够使用，占用 50-80% 是正常的

---

**最后更新**：2026-02-16
